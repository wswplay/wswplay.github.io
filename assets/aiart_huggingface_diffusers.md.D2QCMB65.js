import{_ as n,c as a,o as l,b as p}from"./chunks/framework.DUr976bL.js";const e="/assets/unet-model.BzkQVAu3.png",o="/assets/squaredcos_cap_v2.z8mNtABm.png",F=JSON.parse('{"title":"Diffusers","description":"","frontmatter":{"title":"Diffusers","outline":"deep"},"headers":[{"level":2,"title":"核心 API","slug":"核心-api","link":"#核心-api","children":[{"level":3,"title":"Pipeline(管道)","slug":"pipeline-管道","link":"#pipeline-管道","children":[]},{"level":3,"title":"Model(模型)","slug":"model-模型","link":"#model-模型","children":[]},{"level":3,"title":"Scheduler(调度器)","slug":"scheduler-调度器","link":"#scheduler-调度器","children":[]}]}],"relativePath":"aiart/huggingface/diffusers.md","filePath":"aiart/huggingface/diffusers.md"}'),r={name:"aiart/huggingface/diffusers.md"};function t(c,s,i,E,y,u){return l(),a("div",null,s[0]||(s[0]=[p(`<h1 id="diffusers" tabindex="-1">Diffusers <a class="header-anchor" href="#diffusers" aria-label="Permalink to &quot;Diffusers&quot;">​</a></h1><p>Diffusers is a library of state-of-the-art pretrained diffusion models for generating videos, images, and audio.</p><p><code>Diffusers</code> 是最牛逼的预训练扩散模型库，可生成视频、图片和音频。</p><h2 id="核心-api" tabindex="-1">核心 API <a class="header-anchor" href="#核心-api" aria-label="Permalink to &quot;核心 API&quot;">​</a></h2><p>主要有 3 部分：Pipelines、Models、Schedulers。复杂的扩散模型被拆成 3 个可以独立理解、替换和组合的模块。</p><ol><li><p><strong>Pipelines（流水线：胶水代码 / UX 层）</strong><br> 把模型、调度器、文本编码器、VAE 等<strong>粘在一起</strong>，提供一个<strong>好用的高层接口</strong>。 本质是编排，而不是新算法。</p></li><li><p><strong>Models（模型：算子）</strong><br> 真正做数值计算的部分，比如 <code>UNet2DConditionModel</code>。</p></li></ol><blockquote><p>给定当前 noisy latent + timestep (+ condition)，预测噪声 / 残差。</p></blockquote><ol start="3"><li><strong>Schedulers（调度器：时间积分方法）</strong><br> 用于在推理期间从噪声中生成图像，以及生成用于训练的噪声图像的<strong>各种技术</strong>。不关心网络结构，只定义数学过程。</li></ol><blockquote><p>timestep 怎么走？ 每一步怎么从 <code>x_t</code> 变到 <code>x_{t-1}</code>？</p></blockquote><h3 id="pipeline-管道" tabindex="-1">Pipeline(管道) <a class="header-anchor" href="#pipeline-管道" aria-label="Permalink to &quot;Pipeline(管道)&quot;">​</a></h3><div class="language-py line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">py</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#6A737D;"># 准备工作</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> numpy </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> np</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> torch</span></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> torch.nn.functional </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> F</span></span>
<span class="line"><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> matplotlib </span><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> pyplot </span><span style="color:#F97583;">as</span><span style="color:#E1E4E8;"> plt</span></span>
<span class="line"><span style="color:#F97583;">from</span><span style="color:#79B8FF;"> PIL</span><span style="color:#F97583;"> import</span><span style="color:#E1E4E8;"> Image</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">def</span><span style="color:#B392F0;"> show_images</span><span style="color:#E1E4E8;">(x):</span></span>
<span class="line"><span style="color:#9ECBFF;">   &quot;&quot;&quot;Given a batch of images x, make a grid and convert to PIL&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">   x </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> x </span><span style="color:#F97583;">*</span><span style="color:#79B8FF;"> 0.5</span><span style="color:#F97583;"> +</span><span style="color:#79B8FF;"> 0.5</span><span style="color:#6A737D;">  # Map from (-1, 1) back to (0, 1)</span></span>
<span class="line"><span style="color:#E1E4E8;">   grid </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> torchvision.utils.make_grid(x)</span></span>
<span class="line"><span style="color:#E1E4E8;">   grid_im </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> grid.detach().cpu().permute(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">).clip(</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">*</span><span style="color:#79B8FF;"> 255</span></span>
<span class="line"><span style="color:#E1E4E8;">   grid_im </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> Image.fromarray(np.array(grid_im).astype(np.uint8))</span></span>
<span class="line"><span style="color:#F97583;">   return</span><span style="color:#E1E4E8;"> grid_im</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">def</span><span style="color:#B392F0;"> make_grid</span><span style="color:#E1E4E8;">(images, size</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">64</span><span style="color:#E1E4E8;">):</span></span>
<span class="line"><span style="color:#9ECBFF;">   &quot;&quot;&quot;Given a list of PIL images, stack them together into a line for easy viewing&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">   output_im </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> Image.new(</span><span style="color:#9ECBFF;">&quot;RGB&quot;</span><span style="color:#E1E4E8;">, (size </span><span style="color:#F97583;">*</span><span style="color:#79B8FF;"> len</span><span style="color:#E1E4E8;">(images), size))</span></span>
<span class="line"><span style="color:#F97583;">   for</span><span style="color:#E1E4E8;"> i, im </span><span style="color:#F97583;">in</span><span style="color:#79B8FF;"> enumerate</span><span style="color:#E1E4E8;">(images):</span></span>
<span class="line"><span style="color:#E1E4E8;">      output_im.paste(im.resize((size, size)), (i </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;"> size, </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#F97583;">   return</span><span style="color:#E1E4E8;"> output_im</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 芯片：Mac M1 Pro</span></span>
<span class="line"><span style="color:#E1E4E8;">device </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> torch.device(</span><span style="color:#9ECBFF;">&quot;cuda&quot;</span><span style="color:#F97583;"> if</span><span style="color:#E1E4E8;"> torch.cuda.is_available() </span><span style="color:#F97583;">else</span><span style="color:#9ECBFF;"> &quot;mps&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># 实用pipeline</span></span>
<span class="line"><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> diffusers </span><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> DDPMPipeline</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">butterfly_pipeline </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> DDPMPipeline.from_pretrained(</span><span style="color:#9ECBFF;">&quot;johnowhitaker/ddpm-butterflies-32px&quot;</span><span style="color:#E1E4E8;">).to(device)</span></span>
<span class="line"><span style="color:#E1E4E8;">images </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> butterfly_pipeline(</span><span style="color:#FFAB70;">batch_size</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;">).images</span></span>
<span class="line"><span style="color:#E1E4E8;">make_grid(images)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h3 id="model-模型" tabindex="-1">Model(模型) <a class="header-anchor" href="#model-模型" aria-label="Permalink to &quot;Model(模型)&quot;">​</a></h3><p>大多数扩散模型使用的<strong>模型架构</strong>是 <a href="https://arxiv.org/abs/1505.04597" target="_blank" rel="noreferrer">U-net</a> 或其变体。 <img src="`+e+`" alt="An Image"></p><p><code>Diffusers</code> 提供了开箱即用的 <code>UNet2DModel</code> 类，用来创建模型。</p><div class="language-py line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">py</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> diffusers </span><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> UNet2DModel</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;"># Create a model</span></span>
<span class="line"><span style="color:#E1E4E8;">model </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> UNet2DModel(</span></span>
<span class="line"><span style="color:#FFAB70;">   sample_size</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">image_size,  </span><span style="color:#6A737D;"># the target image resolution</span></span>
<span class="line"><span style="color:#FFAB70;">   in_channels</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">,  </span><span style="color:#6A737D;"># the number of input channels, 3 for RGB images</span></span>
<span class="line"><span style="color:#FFAB70;">   out_channels</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">,  </span><span style="color:#6A737D;"># the number of output channels</span></span>
<span class="line"><span style="color:#FFAB70;">   layers_per_block</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">,  </span><span style="color:#6A737D;"># how many ResNet layers to use per UNet block</span></span>
<span class="line"><span style="color:#FFAB70;">   block_out_channels</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">64</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">128</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">128</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">256</span><span style="color:#E1E4E8;">),  </span><span style="color:#6A737D;"># More channels -&gt; more parameters</span></span>
<span class="line"><span style="color:#FFAB70;">   down_block_types</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#9ECBFF;">      &quot;DownBlock2D&quot;</span><span style="color:#E1E4E8;">,  </span><span style="color:#6A737D;"># a regular ResNet downsampling block</span></span>
<span class="line"><span style="color:#9ECBFF;">      &quot;DownBlock2D&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#9ECBFF;">      &quot;AttnDownBlock2D&quot;</span><span style="color:#E1E4E8;">,  </span><span style="color:#6A737D;"># a ResNet downsampling block with spatial self-attention</span></span>
<span class="line"><span style="color:#9ECBFF;">      &quot;AttnDownBlock2D&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">   ),</span></span>
<span class="line"><span style="color:#FFAB70;">   up_block_types</span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#9ECBFF;">      &quot;AttnUpBlock2D&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#9ECBFF;">      &quot;AttnUpBlock2D&quot;</span><span style="color:#E1E4E8;">,  </span><span style="color:#6A737D;"># a ResNet upsampling block with spatial self-attention</span></span>
<span class="line"><span style="color:#9ECBFF;">      &quot;UpBlock2D&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#9ECBFF;">      &quot;UpBlock2D&quot;</span><span style="color:#E1E4E8;">,  </span><span style="color:#6A737D;"># a regular ResNet upsampling block</span></span>
<span class="line"><span style="color:#E1E4E8;">   ),</span></span>
<span class="line"><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">model.to(device)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h3 id="scheduler-调度器" tabindex="-1">Scheduler(调度器) <a class="header-anchor" href="#scheduler-调度器" aria-label="Permalink to &quot;Scheduler(调度器)&quot;">​</a></h3><div class="language-py line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">py</span><pre class="shiki github-dark vp-code" tabindex="0"><code><span class="line"><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> diffusers </span><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> DDPMScheduler</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">cos_noise_scheduler </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> DDPMScheduler(</span><span style="color:#FFAB70;">num_train_timesteps</span><span style="color:#F97583;">=</span><span style="color:#79B8FF;">1000</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">beta_schedule</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;squaredcos_cap_v2&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">plt.plot(cos_noise_scheduler.alphas_cumprod.cpu() </span><span style="color:#F97583;">**</span><span style="color:#79B8FF;"> 0.5</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">label</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;cos_alphas&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">plt.plot(</span><span style="color:#79B8FF;">1</span><span style="color:#F97583;"> -</span><span style="color:#E1E4E8;"> cos_noise_scheduler.alphas_cumprod.cpu() </span><span style="color:#F97583;">**</span><span style="color:#79B8FF;"> 0.5</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">label</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;1-cos&#39;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">plt.legend(</span><span style="color:#FFAB70;">fontsize</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">&#39;x-large&#39;</span><span style="color:#E1E4E8;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><img src="`+o+'" alt="An Image"><strong>第 1 步</strong>时显示纯输入(原始图片)，<strong>中间步</strong>显示两者融合，<strong>第 1000 步</strong>时显示纯噪音。</p>',18)]))}const m=n(r,[["render",t]]);export{F as __pageData,m as default};
